### =================================================================
### 변수 설정 (실제 환경에 맞게 수정)
### =================================================================
@hostname = http://localhost:8080
@registration_key = password
@username = my-awesome-service
@long_url = https://github.com/google/gemini-api

### =================================================================
### 1. 최초 사용자 등록 및 API Key(Access Token) 발급
### @name: register
### =================================================================
POST {{hostname}}/api/auth/register
Content-Type: application/json
X-REGISTRATION-KEY: {{registration_key}}

{
  "username": "{{username}}"
}

> {%
    // 응답에서 첫 번째 apiKey를 변수에 저장
    client.global.set("initialApiKey", response.body.data.apiKey);
%}

### =================================================================
### 2. 발급받은 API Key로 단축 URL 생성
### =================================================================
POST {{hostname}}/api/short-url
Content-Type: application/json
Authorization: Bearer {{initialApiKey}}

{
  "longUrl": "{{long_url}}",
  "username": "{{username}}"
}

> {%
    // 응답에서 단축 URL 키와 ID를 변수에 저장
    const shortUrl = response.body.data.shortUrl;
    const key = shortUrl.substring(shortUrl.lastIndexOf('/') + 1);
    client.global.set("shortUrlKey", key);
    client.global.set("shortUrlId", response.body.data.id);
%}


### =================================================================
### 3. 생성된 단축 URL로 리디렉션 테스트 (인증 불필요)
### 리디렉션 시 통계 데이터가 적재됩니다.
### =================================================================
GET {{hostname}}/r/{{shortUrlKey}}
Referer: https://www.google.com/
User-Agent: Gemini-Test-Agent/1.0


### =================================================================
### 4. API Key 만료 시나리오: 토큰 재발급 요청
### (X-REGISTRATION-KEY와 만료된 토큰을 함께 전송)
### @name: reissue
### =================================================================
POST {{hostname}}/api/auth/token
Content-Type: application/json
X-REGISTRATION-KEY: {{registration_key}}

{
  "username": "{{username}}",
  "apiKey": "{{initialApiKey}}"
}

> {%
    // 응답에서 새로 발급된 토큰을 변수에 저장
    client.global.set("reissuedApiKey", response.body.data.token);
%}

### =================================================================
### 5. 새로 발급받은 API Key로 다른 단축 URL 생성 테스트
### =================================================================
POST {{hostname}}/api/short-url
Content-Type: application/json
Authorization: Bearer {{reissuedApiKey}}

{
  "longUrl": "https://developers.google.com/gemini",
  "username": "{{username}}"
}

> {%
    // 응답에서 단축 URL 키와 ID를 변수에 저장
    const shortUrl = response.body.data.shortUrl;
    const key = shortUrl.substring(shortUrl.lastIndexOf('/') + 1);
    client.global.set("shortUrlKey", key);
    client.global.set("shortUrlId", response.body.data.id);
%}

### =================================================================
### 6. 생성된 단축 URL로 리디렉션 테스트 (인증 불필요)
### 리디렉션 시 통계 데이터가 적재됩니다.
### =================================================================
GET {{hostname}}/r/{{shortUrlKey}}
Referer: https://www.google.com/
User-Agent: Gemini-Test-Agent/1.0

### =================================================================
### 7. 단축 URL 리디렉션 횟수 조회
### =================================================================
GET {{hostname}}/r/history/{{shortUrlId}}/count
Accept: application/json


### =================================================================
### 8. 단축 URL 통계 조회 (Referer, Year 기준)
### =================================================================
POST {{hostname}}/r/history/{{shortUrlId}}/stats
Content-Type: application/json

{
  "groupBy": ["REFERER", "YEAR"]
}


### =================================================================
### 9. 단축 URL 통계 조회 (User-Agent, Month, Day 기준)
### =================================================================
POST {{hostname}}/r/history/{{shortUrlId}}/stats
Content-Type: application/json

{
  "groupBy": ["USER_AGENT", "MONTH", "DAY"]
}
