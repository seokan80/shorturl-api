### =================================================================
### 변수 설정 (실제 환경에 맞게 수정)
### =================================================================
@hostname = http://localhost:8080
@access_key = shortUrlApi
@username = my-awesome-service
@long_url = https://github.com/google/gemini-api

### =================================================================
### 1. 클라이언트 키 목록 확인
### =================================================================
GET {{hostname}}/api/client-keys
X-CLIENTACCESS-KEY: {{access_key}}

### =================================================================
### 2. 클라이언트 키 발급
### =================================================================
POST {{hostname}}/api/client-keys
Content-Type: application/json
X-CLIENTACCESS-KEY: {{access_key}}

{
  "name": "demo-key",
  "issuedBy": "platform",
  "description": "로컬 테스트"
}

### =================================================================
### 3. 최초 사용자 등록 (토큰은 별도 발급)
### @name: register
### =================================================================
POST {{hostname}}/api/auth/register
Content-Type: application/json
X-CLIENTACCESS-KEY: {{access_key}}

{
  "username": "{{username}}"
}

### =================================================================
### 4. 등록된 사용자 토큰 발급
### @name: issue
### =================================================================
POST {{hostname}}/api/auth/token/issue
Content-Type: application/json
X-CLIENTACCESS-KEY: {{access_key}}

{
  "username": "{{username}}"
}

> {%
    // 발급된 Access/Refresh Token 저장
    client.global.set("initialApiKey", response.body.data.token);
    client.global.set("refreshToken", response.body.data.refreshToken);
%}

### =================================================================
### 5. 발급받은 API Key로 단축 URL 생성
### =================================================================
POST {{hostname}}/api/short-url
Content-Type: application/json
Authorization: Bearer {{initialApiKey}}

{
  "longUrl": "{{long_url}}"
}

> {%
    // 응답에서 단축 URL 키와 ID를 변수에 저장
    const shortUrl = response.body.data.shortUrl;
    const key = shortUrl.substring(shortUrl.lastIndexOf('/') + 1);
    client.global.set("shortUrlKey", key);
    client.global.set("shortUrlId", response.body.data.id);
%}


### =================================================================
### 6. 단축 URL 조회 - ID 기반
### =================================================================
GET {{hostname}}/api/short-url/{{shortUrlId}}
Authorization: Bearer {{initialApiKey}}
Content-Type: application/json


### =================================================================
### 7. 단축 URL 조회 - Key 기반
### =================================================================
GET {{hostname}}/api/short-url/key/{{shortUrlKey}}
Authorization: Bearer {{initialApiKey}}
Content-Type: application/json


### =================================================================
### 8. 단축 URL 삭제
### =================================================================
POST {{hostname}}/api/short-url/delete/{{shortUrlId}}
Authorization: Bearer {{initialApiKey}}
Content-Type: application/json


### =================================================================
### 9. 생성된 단축 URL로 리디렉션 테스트 (인증 불필요)
### 리디렉션 시 통계 데이터가 적재됩니다.
### =================================================================
GET {{hostname}}/r/{{shortUrlKey}}
Referer: https://www.google.com/
User-Agent: Gemini-Test-Agent/1.0


### =================================================================
### 10. API Key 만료 시나리오: 토큰 재발급 요청
### (X-CLIENTACCESS-KEY와 Refresh Token을 함께 전송)
### @name: reissue
### =================================================================
POST {{hostname}}/api/auth/token/re-issue
Content-Type: application/json
X-CLIENTACCESS-KEY: {{access_key}}

{
  "username": "{{username}}",
  "refreshToken": "{{refreshToken}}"
}

> {%
    // 새 Access/Refresh Token 저장
    client.global.set("reissuedApiKey", response.body.data.token);
    client.global.set("refreshToken", response.body.data.refreshToken);
%}

### =================================================================
### 11. 새로 발급받은 API Key로 다른 단축 URL 생성 테스트
### =================================================================
POST {{hostname}}/api/short-url
Content-Type: application/json
Authorization: Bearer {{reissuedApiKey}}

{
  "longUrl": "https://developers.google.com/gemini"
}

> {%
    // 응답에서 단축 URL 키와 ID를 변수에 저장
    const shortUrl = response.body.data.shortUrl;
    const key = shortUrl.substring(shortUrl.lastIndexOf('/') + 1);
    client.global.set("shortUrlKey", key);
    client.global.set("shortUrlId", response.body.data.id);
%}

### =================================================================
### 12. 생성된 단축 URL로 리디렉션 테스트 (인증 불필요)
### 리디렉션 시 통계 데이터가 적재됩니다.
### =================================================================
GET {{hostname}}/r/{{shortUrlKey}}
Referer: https://www.google.com/
User-Agent: Gemini-Test-Agent/1.0

### =================================================================
### 13. 단축 URL 리디렉션 횟수 조회
### =================================================================
GET {{hostname}}/r/history/{{shortUrlId}}/count
Accept: application/json


### =================================================================
### 14. 단축 URL 통계 조회 (Referer, Year 기준)
### =================================================================
POST {{hostname}}/r/history/{{shortUrlId}}/stats
Content-Type: application/json

{
  "groupBy": ["REFERER", "YEAR"]
}


### =================================================================
### 15. 단축 URL 통계 조회 (User-Agent, Month, Day 기준)
### =================================================================
POST {{hostname}}/r/history/{{shortUrlId}}/stats
Content-Type: application/json

{
  "groupBy": ["USER_AGENT", "MONTH", "DAY"]
}
